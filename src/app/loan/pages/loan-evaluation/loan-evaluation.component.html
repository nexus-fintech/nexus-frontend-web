<div class="container mx-auto p-6">
  <h1 class="text-2xl font-bold mb-6 text-slate-800">Loan Evaluation & Risk Analysis</h1>

  <!-- Buscador -->
  <div class="flex gap-4 mb-6 items-end bg-white p-4 rounded shadow-sm">
    <mat-form-field appearance="outline" class="w-48">
      <mat-label>Client ID</mat-label>
      <input matInput type="number" [(ngModel)]="clientIdToSearch">
    </mat-form-field>
    <button mat-raised-button color="primary" (click)="searchLoans()" class="mb-2">
      <mat-icon>search</mat-icon> Search Loans
    </button>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Columna 1: Lista de Préstamos (Tabla) -->
    <div class="lg:col-span-2 bg-white rounded shadow overflow-hidden">
      <table mat-table [dataSource]="loans">
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef> ID </th>
          <td mat-cell *matCellDef="let loan"> {{loan.id}} </td>
        </ng-container>

        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef> Amount </th>
          <td mat-cell *matCellDef="let loan"> ${{loan.requestedAmount}} </td>
        </ng-container>

        <ng-container matColumnDef="rate">
          <th mat-header-cell *matHeaderCellDef> Rate </th>
          <td mat-cell *matCellDef="let loan"> {{loan.annualInterestRate * 100}}% </td>
        </ng-container>

        <ng-container matColumnDef="term">
          <th mat-header-cell *matHeaderCellDef> Term </th>
          <td mat-cell *matCellDef="let loan"> {{loan.termInMonths}}m </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Status </th>
          <td mat-cell *matCellDef="let loan">
            <span class="px-2 py-1 rounded text-xs font-bold"
                  [class.bg-yellow-100]="loan.status === 'REQUESTED'"
                  [class.text-yellow-800]="loan.status === 'REQUESTED'"
                  [class.bg-green-100]="loan.status === 'ACTIVE'"
                  [class.text-green-800]="loan.status === 'ACTIVE'"
                  [class.bg-red-100]="loan.status === 'REJECTED'"
                  [class.text-red-800]="loan.status === 'REJECTED'">
              {{loan.status}}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Action </th>
          <td mat-cell *matCellDef="let loan">
            @if (loan.status === 'REQUESTED') {
              <button mat-stroked-button color="accent" (click)="selectForApproval(loan)">
                Evaluate
              </button>
            }
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>

    <!-- Columna 2: Panel de Aprobación -->
    <div class="lg:col-span-1">
      @if (selectedLoanId) {
        <div class="bg-white p-6 rounded shadow border-t-4 border-accent">
          <h3 class="text-lg font-bold mb-4">Evaluating Loan #{{selectedLoanId}}</h3>
          <app-loan-approval-form (approvalSubmitted)="onApprovalSubmit($event)"></app-loan-approval-form>
        </div>
      } @else {
        <div class="bg-slate-50 p-6 rounded border border-dashed border-slate-300 text-center text-gray-500">
          Select a "REQUESTED" loan to start risk evaluation.
        </div>
      }
    </div>

  </div>
</div>
